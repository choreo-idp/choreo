# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OpenChoreo is an open-source Internal Developer Platform (IDP) that provides Kubernetes-native abstractions for
developers and platform engineers.
It implements a multi-plane architecture with control plane, and data plane separation using custom Kubernetes CRDs.

## Architecture Overview

### Multi-Plane Architecture

OpenChoreo implements a multi-plane architecture that separates concerns between control and execution:

- **Control Plane**: Hosts OpenChoreo controllers, manages developer intent, and orchestrates resources
- **Data Plane**: Kubernetes clusters where the actual workloads run, managed by the control plane

### Design Principles

OpenChoreo follows core architectural patterns that separate developer abstractions from platform engineer governance:

- **Claim/Class Pattern**: Platform Engineers define Classes (templates/governance), Developers create Claims (intent)
- **Workload as Source Code Definition**: Workload is a special resource that defines the source code for certain
  component types. It defines containers, configurations, endpoints and connections.
- **Environment Independence**: Developer intent resources (ComponentV2, Workload, API, Service, ScheduledTask,
  WebApplication) are not bound to specific environments
- **Environment-Bound Bindings**: Binding resources (ServiceBinding, ScheduledTaskBinding, WebApplicationBinding,
  APIBinding) are environment-specific copies of component type resources (Service, ScheduledTask, WebApplication, API)
  that include both the component's type-specific configurations and its associated workload specification. Each binding
  references a specific environment via an `environmentName` field and can be created by users during promotion to
  higher environments
- **Final Resource Releases**: Release resources (ServiceRelease, ScheduledTaskRelease, WebApplicationRelease,
  APIRelease) contain the final Kubernetes manifests generated by Binding controllers and are deployed to data plane
  clusters
- **Multi-Plane Separation**: Control plane manages intent and orchestration, data planes run the actual workloads

### Domain Model

```
OpenChoreo Platform
└── Organization (just a K8s namespace) - Many organizations
    ├── ServiceClass (PE-defined templates to govern services)
    ├── ScheduledTaskClass (PE-defined templates to govern scheduled tasks)
    ├── WebApplicationClass (PE-defined templates to govern web applications)
    ├── APIClass (PE-defined templates to govern APIs)
    ├── Project - Many per organization (references DeploymentPipeline)
    │   └── Component (ComponentV2) - Many per project
    │       ├── Workload (describes source code with configurations, endpoints and connections)
    │       ├── DeploymentTrack - Many per component (Optional - Git branch alignment)
    │       ├── Service (References Component's Workload & Organization's ServiceClass)
    │       ├── ServiceBinding
    │       ├── ServiceRelease
    │       ├── ScheduledTask (References Component's Workload & Organization's ScheduledTaskClass)
    │       ├── ScheduledTaskBinding
    │       ├── ScheduledTaskRelease
    │       ├── WebApplication (References Component's Workload & Organization's WebApplicationClass)
    │       ├── WebApplicationBinding
    │       ├── WebApplicationRelease
    │       ├── API (References Organization's APIClass)
    │       ├── APIBinding
    │       └── APIRelease
    ├── DeploymentPipeline - Many per organization (defines promotion order between environments)
    ├── Environment - Many per organization (References DataPlane)
    ├── DataPlane - Many per organization
    └── GitCommitRequest - Many per organization (Optional - GitOps automation)
```

**Key Relationships:**

- **One Organization → Many Project**: Each organization (K8s namespace) contains multiple projects
- **One Organization → Many Class**: Each organization contains Platform Engineer-defined Class templates
- **One Organization → Many Environment**: Each organization can have multiple environments (dev, staging, prod)
- **One Organization → Many DataPlane**: Each organization can have multiple DataPlane clusters
- **One Organization → Many DeploymentPipeline**: Each organization can define multiple deployment pipelines to enforce
  promotion order between environments
- **One Project → One DeploymentPipeline**: Each project references a deployment pipeline that defines the promotion
  order for its components
- **One Environment → One DataPlane**: Each environment references a specific DataPlane for deployment
- **One Project → Many Component**: Each project contains multiple ComponentV2 resources
- **One Component → One Type**: Each Component has exactly one type (Service, ScheduledTask, WebApplication, etc.)
- **One Component → Zero or One Workload**: Each Component may have zero or exactly one Workload (pure data structure)
- **One Component → Many DeploymentTrack**: Each Component can have multiple DeploymentTracks (optional for Git branch
  alignment)
- **Runtime Component Types → Reference Workload**: Service, ScheduledTask, and WebApplication reference their
  Component's Workload
- **All Component Types → Reference Organization Classes**: All component types reference their Organization's Class
  templates
- **Bindings → Copy Workload & Reference Classes**: Bindings contain a copy of the workload spec but still reference
  Classes for governance
- **Component-Type-Specific Controllers**: Each type has its own controller, class, binding, and release resources
- **Claim/Class Pattern**: Developers create Claims (component types), Platform Engineers define Classes (governance)
- **Binding Pattern**: Environment-bound copies for progressive delivery
- **Release Pattern**: Created by Binding controllers, contain final K8s manifests sent to data plane

## Project Structure

### Directory Layout

```
├── api/v1/                     # Kubernetes CRD type definitions
├── cmd/                        # Application entry points
│   ├── main.go                 # Controller manager main
│   └── choreoctl/              # CLI tool
├── config/                     # Kubernetes manifests and configurations
│   ├── crd/bases/              # Generated CRD YAML files
│   ├── rbac/                   # RBAC configurations
│   ├── samples/                # Sample CRD instances
│   └── manager/                # Controller manager deployment
├── internal/controller/        # Controller implementations
│   ├── component/              # DEPRICATED - Legacy component controller
│   ├── componentv2/            # New component controller
│   ├── workload*/              # Workload-related controllers (workload, workloadclass, workloadbinding, workloadrelease)
│   ├── api*/                   # API-related controllers (api, apiclass, apibinding, apirelease)
│   ├── endpoint*/              # DEPRICATED - Legacy endpoint controllers (endpoint, endpointclass, endpointrelease, endpointv2)
│   ├── scheduledtask*/         # ScheduledTask-related controllers (scheduledtask, scheduledtaskclass, scheduledtaskbinding, scheduledtaskrelease)
│   ├── service*/               # Service-related controllers (service, serviceclass, servicebinding, servicerelease)
│   ├── webapplication*/        # WebApplication-related controllers (webapplication, webapplicationclass, webapplicationbinding, webapplicationrelease)
│   ├── deployment*/            # DEPRICATED - Legacy deployment-related controllers (deployment, deployableartifact, deploymenttrack)
│   ├── deploymentpipeline/     # DeploymentPipeline controller
│   ├── dataplane/              # DataPlane controller
│   ├── environment/            # Environment controller
│   ├── organization/           # Organization controller
│   ├── project/                # Project controller
│   └── gitcommitrequest/       # GitOps automation controller
├── internal/dataplane/         # Data plane integration utilities
├── docs/                       # Project documentation
├── samples/                    # Real-world usage examples
├── install/                    # Installation scripts and Helm charts
│   ├── helm/choreo-control-plane/  # Control plane Helm chart
│   └── helm/choreo-dataplane/      # Data plane Helm chart
└── new-design-sample/          # Sample YAMLs for new CRD design
```

### Core Components

- **Controller Manager (`cmd/main.go`)**: Main Kubernetes controller with CRD reconcilers that run in the control plane
- **CLI (`cmd/choreoctl/`)**: User-facing command-line (`choreoctl`) tool

### Controller Manager

- **CRD Types**: Kubernetes CRD Go types are defined in `api/v1/<singular-crd-name>_types.go`
- **Controller Logic**: Each controller logic will reside in `internal/controller/<singular-crd-name>/` package

## Essential Commands

For comprehensive development guides, see @docs/contributors/README.md or run `make help` for all available commands.

### Linting and Formatting

- `make lint` - Run golangci-lint linter
- `make lint-fix` - Run linter with automatic fixes

### Code Generation

- `make code.gen` - Generate all code (manifests, deepcopy, lint fixes)
- `make code.gen-check` - Verify no uncommitted changes after generation
- `make generate manifests` - Generate DeepCopy methods, CRDs, RBAC, and webhook configurations

### Building

- `make go.build` - Build all binaries (manager, choreoctl) for current platform
- `make go.build.manager` - Build controller manager only

## Deprecated CRDs

The following CRDs are **deprecated** and were added for initial testing. They can be referenced for inspiration or to
find common patterns, but should **NOT** be used as reference for new CRDs:

### Legacy/Deprecated CRDs

- **Build** - Legacy build system
- **Component** - Replaced by ComponentV2
- **ConfigurationGroup** - Legacy configuration pattern
- **DeployableArtifact** - Legacy deployment pattern
- **Deployment** - Legacy deployment pattern
- **Endpoint** - Replaced by workload endpoints (API vs Endpoint design)
- **EndpointClass** - Replaced by workload endpoints (API vs Endpoint design)
- **EndpointRelease** - Replaced by workload endpoints (API vs Endpoint design)
- **EndpointV2** - Replaced by workload endpoints (API vs Endpoint design)
- **WorkloadBinding** - Legacy workload pattern
- **WorkloadClass** - Legacy workload pattern
- **WorkloadRelease** - Legacy workload pattern

**Note**: These deprecated CRDs represent old architecture patterns that have been replaced by the current
Claim/Class/Binding/Release pattern and API vs Endpoint design principles.

## Important Notes

- **CRD Updates**: Always run `make manifests generate install` after modifying API types in `api/v1/`
- **Controller Patterns**: The project follows standard Kubernetes controller patterns and conventions
